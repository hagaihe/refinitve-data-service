import asyncio
import logging

from app.cache.closing_prices_cache import ClosingPriceCache
from app.ib.ib_price_fetcher import IBPriceFetcher
from app.ib.ibclient import IBClient

logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s - %(name)s - %(levelname)s - [%(threadName)s] - %(message)s')
logger = logging.getLogger(__name__)


class IBPriceFetcherTest:
    def __init__(self):
        self.ib_client = IBClient(port=7481, client_id=158)
        self.fetcher = IBPriceFetcher(self.ib_client)

    async def run(self):
        test_symbols = ["AAXJ",
        "ACSI",
        "ACWI",
        "ACWV",
        "ACWX",
        "ADME",
        "ADPV",
        "ADX",
        "AESR",
        "AFLG",
        "AGZ",
        "AIA",
        "AIEQ",
        "AIQ",
        "AIRR",
        "AIVL",
        "ALTL",
        "AMOM",
        "AOA",
        "AOTG",
        "APUE",
        "ARTY",
        "ASG",
        "ATFV",
        "AUSF",
        "AVDE",
        "AVDV",
        "AVEM",
        "AVLC",
        "AVLV",
        "AVSC",
        "AVSU",
        "AVUS",
        "AVUV",
        "BAMG",
        "BBEU",
        "BBMC",
        "BBUS",
        "BCHP",
        "BCUS",
        "BEEZ",
        "BIBL",
        "BKIV",
        "BKLC",
        "BKWO",
        "BLCR",
        "BLCV",
        "BLES",
        "BMVP",
        "BRNY",
        "BSVO",
        "BUFR",
        "BUL",
        "BUSA",
        "BUZZ",
        "BWTG",
        "CALF",
        "CAPE",
        "CATH",
        "CDC",
        "CDEI",
        "CET",
        "CFO",
        "CGDV",
        "CGGO",
        "CGGR",
        "CGUS",
        "CGW",
        "CGXU",
        "CHGX",
        "CIBR",
        "CLM",
        "CLOU",
        "COWG",
        "COWZ",
        "CPAI",
        "CRBN",
        "CRF",
        "CSM",
        "CVAR",
        "CVLC",
        "CVSE",
        "CWI",
        "CWS",
        "CZA",
        "DALI",
        "DARP",
        "DBEF",
        "DBEM",
        "DCOR",
        "DDWM",
        "DEEF",
        "DEM",
        "DEMZ",
        "DES",
        "DEUS",
        "DFAC",
        "DFAE",
        "DFAI",
        "DFAS",
        "DFAT",
        "DFAU",
        "DFEM",
        "DFIC",
        "DFIS",
        "DFIV",
        "DFLV",
        "DFSU",
        "DFSV",
        "DFUV",
        "DFVE",
        "DFVX",
        "DGRO",
        "DGRS",
        "DGRW",
        "DGS",
        "DHS",
        "DIA",
        "DIM",
        "DISV",
        "DIVO",
        "DJD",
        "DLN",
        "DLS",
        "DOL",
        "DON",
        "DRUP",
        "DSI",
        "DTD",
        "DUBS",
        "DUHP",
        "DUSA",
        "DVOL",
        "DVY",
        "DVYE",
        "DWM",
        "DWX",
        "DYNF",
        "DYNI",
        "EATV",
        "ECML",
        "EDIV",
        "EDOW",
        "EDV",
        "EEA",
        "EELV",
        "EEM",
        "EEMA",
        "EEMV",
        "EES",
        "EFA",
        "EFAD",
        "EFAV",
        "EFG",
        "EFIV",
        "EFV",
        "EGUS",
        "EMGF",
        "EMXC",
        "EPP",
        "EPS",
        "EQAL",
        "EQL",
        "EQRR",
        "EQS",
        "EQWL",
        "ESG",
        "ESGD",
        "ESGE",
        "ESGU",
        "ESGV",
        "ESML",
        "ESMV",
        "ETHO",
        "EUFN",
        "EUSA",
        "EVT",
        "EVUS",
        "EWX",
        "EXI",
        "EZM",
        "FAD",
        "FBCG",
        "FBCV",
        "FCFY",
        "FCPI",
        "FCTR",
        "FDCE",
        "FDG",
        "FDGR",
        "FDIS",
        "FDLO",
        "FDRR",
        "FDT",
        "FDVL",
        "FDVV",
        "FDWM",
        "FELC",
        "FELG",
        "FELV",
        "FEM",
        "FENI",
        "FEP",
        "FEUS",
        "FEX",
        "FEZ",
        "FFLG",
        "FFLV",
        "FFND",
        "FFTY",
        "FGD",
        "FIDU",
        "FIW",
        "FLGV",
        "FLOW",
        "FLQL",
        "FLQM",
        "FLRG",
        "FLV",
        "FMAG",
        "FMCX",
        "FMDE",
        "FNDA",
        "FNDB",
        "FNDE",
        "FNDX",
        "FNX",
        "FNY",
        "FOF",
        "FORH",
        "FPX",
        "FQAL",
        "FSST",
        "FSZ",
        "FTA",
        "FTC",
        "FTCS",
        "FTEC",
        "FUND",
        "FUNL",
        "FV",
        "FVAL",
        "FVC",
        "FVD",
        "FXD",
        "FXH",
        "FXL",
        "FXO",
        "FXR",
        "FYC",
        "FYX",
        "GAB",
        "GAL",
        "GAM",
        "GARP",
        "GCOW",
        "GDV",
        "GEM",
        "GF",
        "GGM",
        "GGRW",
        "GGUS",
        "GK",
        "GMF",
        "GNR",
        "GOCT",
        "GOVI",
        "GQI",
        "GRF",
        "GRID",
        "GSC",
        "GSEW",
        "GSIE",
        "GSLC",
        "GSPY",
        "GSSC",
        "GSUS",
        "GUNR",
        "GURU",
        "GUSA",
        "GVIP",
        "GVUS",
        "GWX",
        "HACK",
        "HAPI",
        "HDEF",
        "HDMV",
        "HDUS",
        "HEAT",
        "HEDJ",
        "HEEM",
        "HEFA",
        "HELO",
        "HERD",
        "HFGO",
        "HKND",
        "HLAL",
        "HLGE",
        "HQGO",
        "HTD",
        "HUSV",
        "IBB",
        "ICOW",
        "IDEV",
        "IDLV",
        "IDV",
        "IEF",
        "IEFA",
        "IEMG",
        "IETC",
        "IEUR",
        "IEV",
        "IFRA",
        "IGF",
        "IGM",
        "IHDG",
        "IJJ",
        "IJK",
        "IJS",
        "IJT",
        "ILCB",
        "ILCG",
        "ILCV",
        "IMCG",
        "IMCV",
        "IMTM",
        "INCE",
        "INTF",
        "IOO",
        "IPAY",
        "IQDG",
        "IQLT",
        "IQSU",
        "ISCF",
        "ISMD",
        "ISWN",
        "ITAN",
        "ITOT",
        "IUS",
        "IUSG",
        "IUSV",
        "IVAL",
        "IVE",
        "IVLU",
        "IVOG",
        "IVOV",
        "IVV",
        "IVW",
        "IWB",
        "IWC",
        "IWD",
        "IWF",
        "IWFG",
        "IWL",
        "IWLG",
        "IWM",
        "IWO",
        "IWP",
        "IWR",
        "IWS",
        "IWV",
        "IWX",
        "IWY",
        "IXG",
        "IXN",
        "IXP",
        "IXUS",
        "IYC",
        "IYF",
        "IYG",
        "IYJ",
        "IYW",
        "IYY",
        "IYZ",
        "JAVA",
        "JCTR",
        "JGLO",
        "JGRO",
        "JHAC",
        "JHEM",
        "JHMD",
        "JHML",
        "JHMM",
        "JHSC",
        "JIRE",
        "JMEE",
        "JMOM",
        "JOET",
        "JPEM",
        "JPME",
        "JPSE",
        "JPUS",
        "JQUA",
        "JUST",
        "JVAL",
        "KIE",
        "KNG",
        "KOMP",
        "KONG",
        "KRMA",
        "KVLE",
        "LCF",
        "LCTU",
        "LEAD",
        "LFEQ",
        "LGH",
        "LGLV",
        "LGRO",
        "LOPP",
        "LOWV",
        "LQAI",
        "LRGC",
        "LRGE",
        "LRGF",
        "LRND",
        "LSGR",
        "LVHD",
        "MBCC",
        "MDY",
        "MDYG",
        "MDYV",
        "MFEM",
        "MFUS",
        "MGC",
        "MGK",
        "MGV",
        "MILN",
        "MMLG",
        "MMTM",
        "MOO",
        "MOTE",
        "MRNY",
        "MSMR",
        "MSTB",
        "MSTQ",
        "MTUM",
        "MVPA",
        "NACP",
        "NANC",
        "NFRA",
        "NOBL",
        "NSCR",
        "NUDM",
        "NUEM",
        "NUGO",
        "NULC",
        "NULG",
        "NULV",
        "NUMV",
        "NUSC",
        "NWLG",
        "NXTG",
        "NZUS",
        "OALC",
        "OEF",
        "OMFL",
        "OMFS",
        "ONEQ",
        "ONEV",
        "ONEY",
        "OSCV",
        "OUSA",
        "OVL",
        "OVLH",
        "PABU",
        "PALC",
        "PBUS",
        "PDN",
        "PDP",
        "PEXL",
        "PEY",
        "PFM",
        "PFUT",
        "PGRO",
        "PHO",
        "PIE",
        "PJBF",
        "PJFG",
        "PJFV",
        "PKW",
        "PLDR",
        "POWA",
        "PPA",
        "PRF",
        "PRFZ",
        "PRNT",
        "PSC",
        "PSET",
        "PSI",
        "PTEU",
        "PTLC",
        "PTNQ",
        "PVAL",
        "PWB",
        "PWV",
        "PXF",
        "PXH",
        "PY",
        "QARP",
        "QDEF",
        "QDF",
        "QEFA",
        "QEMM",
        "QGRO",
        "QGRW",
        "QLC",
        "QLTY",
        "QLV",
        "QOWZ",
        "QQEW",
        "QQH",
        "QQMG",
        "QQQ",
        "QQQA",
        "QQQE",
        "QQQM",
        "QQXT",
        "QRFT",
        "QTEC",
        "QUAL",
        "QUS",
        "QUVU",
        "QVML",
        "QWLD",
        "RAFE",
        "RDIV",
        "RDVY",
        "RECS",
        "REGL",
        "REVS",
        "RFDA",
        "RFDI",
        "RFEM",
        "RFFC",
        "RFG",
        "RHRX",
        "RJMG",
        "RMT",
        "ROAM",
        "RODM",
        "ROE",
        "ROUS",
        "RPG",
        "RPHS",
        "RPV",
        "RSP",
        "RSPE",
        "RSPT",
        "RSSL",
        "RUNN",
        "RVRB",
        "RVT",
        "RWJ",
        "RWK",
        "RWL",
        "RXI",
        "RZG",
        "SAMT",
        "SCHA",
        "SCHB",
        "SCHC",
        "SCHE",
        "SCHF",
        "SCHG",
        "SCHK",
        "SCHM",
        "SCHQ",
        "SCHV",
        "SCHX",
        "SCZ",
        "SDVY",
        "SDY",
        "SECT",
        "SEIM",
        "SEIQ",
        "SEIV",
        "SELV",
        "SFLO",
        "SFY",
        "SFYF",
        "SGLC",
        "SHE",
        "SIXA",
        "SIZE",
        "SKYY",
        "SLYG",
        "SLYV",
        "SMDV",
        "SMH",
        "SMLF",
        "SMMD",
        "SMMV",
        "SMOT",
        "SMRI",
        "SNPD",
        "SNPE",
        "SNPG",
        "SNPV",
        "SOCL",
        "SOR",
        "SPBC",
        "SPCX",
        "SPDV",
        "SPDW",
        "SPE",
        "SPEM",
        "SPEU",
        "SPGM",
        "SPGP",
        "SPHB",
        "SPHD",
        "SPHQ",
        "SPLG",
        "SPLV",
        "SPMO",
        "SPMV",
        "SPSM",
        "SPTL",
        "SPTM",
        "SPUS",
        "SPVM",
        "SPVU",
        "SPXE",
        "SPXN",
        "SPXT",
        "SPXV",
        "SPY",
        "SPYD",
        "SPYG",
        "SPYV",
        "SPYX",
        "SQEW",
        "SRHQ",
        "SSPX",
        "SSPY",
        "SSUS",
        "STNC",
        "STRV",
        "STXG",
        "STXV",
        "SURE",
        "SUSA",
        "SUSL",
        "SVAL",
        "SWAN",
        "SXQG",
        "SZNE",
        "TBG",
        "TCAF",
        "TCHP",
        "TDIV",
        "TDVG",
        "TGLR",
        "TGRT",
        "TGRW",
        "THLV",
        "TILT",
        "TLH",
        "TLT",
        "TLTD",
        "TLTE",
        "TMFC",
        "TMFE",
        "TOLL",
        "TPLC",
        "TPLE",
        "TRND",
        "TSPA",
        "TUA",
        "TVAL",
        "TY",
        "URTH",
        "USCA",
        "USCF",
        "USCL",
        "USMC",
        "USMF",
        "USMV",
        "USNZ",
        "USPX",
        "USRD",
        "USSE",
        "USSG",
        "USXF",
        "UTEN",
        "UTHY",
        "UTWY",
        "VALQ",
        "VB",
        "VBK",
        "VBR",
        "VCR",
        "VEA",
        "VEGN",
        "VEU",
        "VFH",
        "VFLO",
        "VFMF",
        "VFMO",
        "VFMV",
        "VFQY",
        "VFVA",
        "VGK",
        "VIDI",
        "VIG",
        "VIGI",
        "VIOG",
        "VIOO",
        "VIOV",
        "VIS",
        "VLU",
        "VLUE",
        "VMAX",
        "VNSE",
        "VO",
        "VOE",
        "VONE",
        "VONG",
        "VONV",
        "VOO",
        "VOOG",
        "VOOV",
        "VOT",
        "VOTE",
        "VSGX",
        "VSLU",
        "VSMV",
        "VSS",
        "VTHR",
        "VTI",
        "VTV",
        "VTWG",
        "VTWV",
        "VUG",
        "VUSE",
        "VV",
        "VWO",
        "VXF",
        "VXUS",
        "VYM",
        "VYMI",
        "WBIF",
        "WBIL",
        "WBIY",
        "WCEO",
        "WINN",
        "WOMN",
        "WTV",
        "XAR",
        "XHB",
        "XLF",
        "XLG",
        "XLK",
        "XLSR",
        "XMHQ",
        "XMVM",
        "XNTK",
        "XOCT",
        "XOVR",
        "XRLV",
        "XSHQ",
        "XSOE",
        "XT",
        "XTN",
        "XVOL",
        "XVV",
        "YALL",
        "ZECP",
        "ZIG",
        "ZROZ",
        "bbsc",
        "bfor",
        "csd",
        "dstl",
        "dwas",
        "eagl",
        "fdm",
        "fsmd",
        "grpm",
        "imcb",
        "iscg",
        "oneo",
        "qqqj",
        "ryld",
        "tmsl",
        "xmlv",
        "xmmo",
        "xsmo",
        "xsvm"]

        logger.info(f"Fetching prices for {len(test_symbols)}")
        await self.fetcher.fetch_prices(test_symbols)

        # Print cached prices
        cache = ClosingPriceCache.instance()
        for symbol in test_symbols:
            prices = await cache.get_prices(symbol)
            if prices and 'ib_close' in prices:
                logger.info(f"Cached {symbol} adjusted close: {prices['ib_close']}")
            else:
                logger.warning(f"{symbol} has no adjusted close in cache")


if __name__ == '__main__':
    tester = IBPriceFetcherTest()
    asyncio.run(tester.run())
